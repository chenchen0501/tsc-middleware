# TSC-Print-Service

**“零驱动”局域网打印中间件｜ macOS(M4)开发 ➜ Windows 部署**

---

## 1. 总体目标

- 在 **macOS(M4)** 上快速开发、自测
- 通过 **HTTP 接口** 暴露「生成标签 ➜ 推打印机」能力
- 代码 100% 跨平台，**Windows** 上 `pip + python` 即可运行，**无需额外驱动**
- 适配 **TSC 全系列**（USB/Network）

---

## 2. 技术选型

| 层级       | 组件                       | 说明                     |
| ---------- | -------------------------- | ------------------------ |
| 语言       | Python≥3.10                | 开发/生产同一套代码      |
| 打印库     | `tsclib` + `tsclibnet.dll` | 官方 DLL，已封装 USB/LAN |
| Web 框架   | FastAPI                    | 轻量、自动生成 OpenAPI   |
| 跨平台 CLR | .NET6-Runtime              | Win 自带；macOS 需额外装 |
| 打包       | 内置                       | 单文件夹，绿色部署       |

---

## 3. 开发环境(macOS-M4)安装

```bash
# 1️⃣ Rosetta(仅M4)
/usr/sbin/softwareupdate --install-rosetta --agree-to-license

# 2️⃣ x86_64 Homebrew(仅M4)
arch -x86_64 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# 3️⃣ mono+x86_64版libgdiplus
arch -x86_64 /usr/local/bin/brew install mono libgdiplus

# 4️⃣ Python虚拟环境
python3 -m venv venv
source venv/bin/activate
pip install -U pip wheel

# 5️⃣ 项目依赖
pip install fastapi uvicorn tsclib pydantic
```

> 验证：`python -c "from tsclib import TSCPrinter;print('OK')"`  
> 出现 `OK` 即 CLR 托管成功，可继续开发。

---

## 4. 项目结构

```
tsc-print-service/
 ├─ main.py              # FastAPI入口
 ├─ printer.py           # 打印核心(跨平台)
 ├─ settings.py          # 配置IP/端口
 ├─ requirements.txt
 └─ README.md
```

---

## 5. 核心代码

### 5.1 printer.py（打印库隔离）

```python
from tsclib import TSCPrinter

def print_label(
        ip: str,
        text: str,
        barcode: str,
        qty: int = 1,
        width: str = "50", height: str = "30"
):
    p = TSCPrinter()
    try:
        p.open_port(f"{ip}:9100")
        p.setup_label(width, height, "4", "10", "0", "2", "0")
        p.clear_buffer()
        p.windowsfont(20, 20, 32, 0, 0, 0, "Arial", text)
        p.barcode("20", "80", "128", 60, 1, 0, 2, 2, barcode)
        p.print_label(qty)
    finally:
        p.close_port()
```

### 5.2 main.py（HTTP 接口）

```python
from fastapi import FastAPI, HTTPException
from pydantic import BaseModel
from printer import print_label

app = FastAPI(title="TSC-Print-Service", version="1.0.0")

class Job(BaseModel):
    ip: str
    text: str
    barcode: str
    qty: int = 1

@app.post("/print")
def api_print(job: Job):
    try:
        print_label(job.ip, job.text, job.barcode, job.qty)
        return {"status": "ok"}
    except Exception as e:
        raise HTTPException(500, str(e))

@app.get("/health")
def health():
    return {"status": "alive"}
```

---

## 6. 本地启动（开发自测）

```bash
uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```

- 浏览 `http://localhost:8000/docs` 可见交互式 Swagger
- 例：`POST /print`
  ```json
  {
    "ip": "192.168.1.100",
    "text": "Hello M4",
    "barcode": "1234567890",
    "qty": 1
  }
  ```
  打印机立即出纸即表示通路完成。

---

## 7. 跨平台部署（Windows）

### 7.1 系统要求

- Windows 10/11 (x64)
- .NET6-Runtime (官方安装包，已含于 Win11 22H2+)
- Python 3.10-3.12 (Microsoft Store 或官方安装包)
- VC++ 2015-2022 Redistributable (x86) - 如遇错误 0x8007007e 时需要

### 7.2 方式一：自动安装（推荐）

**双击运行 `setup_windows.bat`**，脚本会自动完成以下步骤：

1. ✅ 检查 Python 版本（需 3.10-3.12）
2. ✅ 创建虚拟环境 `venv`
3. ✅ 升级 pip 和 wheel
4. ✅ 安装所有依赖包
5. ✅ 验证 TSCLib 是否正常加载
6. ✅ 提示可能需要的 VC++ 运行库

**如果验证失败**：

- 下载安装 [VC++ 2015-2022 (x86)](https://aka.ms/vs/17/release/vc_redist.x86.exe)
- 重启电脑
- 重新运行 `setup_windows.bat`

安装成功后，**双击 `run.bat`** 即可启动服务。

### 7.3 方式二：手动安装

```powershell
# 1. Python虚拟环境
py -3.12 -m venv venv
venv\Scripts\activate
python -m pip install -U pip wheel

# 2. 安装依赖
pip install -r requirements.txt
# requirements.txt 内容：
# fastapi>=0.104.0
# uvicorn[standard]>=0.24.0
# tsclib>=0.1.3
# pydantic>=2.0.0

# 3. 验证安装
python -c "from tsclib import TSCPrinter; print('✅ 安装成功')"
```

### 7.4 启动服务

**方法 1：使用批处理脚本（推荐）**

```
双击 run.bat
```

**方法 2：命令行启动**

```powershell
venv\Scripts\activate
python main.py
# 或
uvicorn main:app --host 0.0.0.0 --port 8000
```

访问：

- 服务地址：`http://localhost:8000`
- API 文档：`http://localhost:8000/docs`

### 7.5 测试打印机连接和打印

**双击 `test_printer.bat`**，按提示输入打印机 IP 地址，脚本会自动完成：

1. ✅ 测试打印机连接
2. ✅ 自动打印测试标签（文本："Hello Javaly"，条码："TEST123456"）

这样可以一键验证整个打印链路是否正常工作。

> 若需 80 端口/后台常驻，可用 **Windows Service** 或 **nssm** 包装，文档略。

---

## 8. 生成系统调用示例

任意语言只要发 HTTP 即可：

```bash
curl -X POST http://<service-ip>:8000/print \
  -H "Content-Type: application/json" \
  -d '{"ip":"192.168.1.100","text":"Batch-2025","barcode":"BAT20250625","qty":2}'
```

返回：

```json
{ "status": "ok" }
```

---

## 9. 常见故障码

| 现象                      | 可能原因         | 检查项                                    |
| ------------------------- | ---------------- | ----------------------------------------- |
| `500 "printer not found"` | IP 错/离线       | ping 打印机                               |
| `500 "0x8007007e"`        | Win 缺 VC 运行库 | 安装 **VC2015-2022 x86**                  |
| `libgdiplus not found`    | macOS 库路径     | `export DYLD_LIBRARY_PATH=/usr/local/lib` |

---

## 10. 版本记录

| 日期       | 版本   | 说明                        |
| ---------- | ------ | --------------------------- |
| 2025-06-25 | v1.0.0 | 初版；M4 开发 →Win 部署通过 |

---

## 11. Windows 快速部署指南

**复制整个文件夹到 Windows 后：**

1. **首次安装**：双击 `setup_windows.bat` → 等待安装完成
2. **测试打印**：双击 `test_printer.bat` → 输入打印机 IP → 自动打印测试标签
3. **启动服务**：双击 `run.bat` → 访问 http://localhost:8000/docs

**脚本说明**：

- `setup_windows.bat` - 自动安装脚本（检查环境、创建虚拟环境、安装依赖）
- `test_printer.bat` - 打印机测试工具（测试连接 + 自动打印"Hello Javaly"标签）
- `run.bat` - 启动服务脚本（自动激活虚拟环境并启动 FastAPI）

> 后续功能（USB 口、二维码、模板）只需在 `printer.py` 里扩展，接口不变。
